<html>
<head>
<script  type="application/javascript" src="\brains.js"></script>
<script type="application/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
<!-- Include Tailwind CSS from CDN -->
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body>
<div id="app" class="w-full">
    <div id="sheet-container" class="flex flex-col w-full items-center justify-center">
        <div  class="w-4/6" v-for="(character, index) in characters" :key="index">
          <form :id="character.id" class="parchment w-full">
            <div class="parchment_header flex justify-between">
            <div>
            <h1 class="text-4xl underline mb-1">{{ character.name }}</h1>
            <div v-for="(value, key) in character.sheet" :key="key"  v-if="value.type == 'B'" class="mb-1">
                    <label>{{ removeUnderline(key) }}:</label>  
                    <input type="text" :key="key" :name="key" v-model="value.value" />
            </div>
        </div>
        <div></div>
        <div>
            <span v-if="character.picture">  
            <img class="img-border" width="275px" height="275px" v-if="character.picture ":src="character.picture" alt="Image" />  
            </span> 
            <span v-else>
            <img class="img-border" width="275px" height="275px" src="https://via.placeholder.com/250x250" alt="Image" />
            </span>
            </div>
            </div>
            <hr class="bg-black border-black" />
            <div class="flex">
            <div class="mt-2 w-full">
            <b class="underline">Core Stats</b>
            <div v-for="(value, key) in character.sheet" :key="key"  v-if="value.type == 'C'" class="section-header mb-1">
                <div class="flex flex-col">
                <label>{{ key }}</label>  
                <input class="w-2/3" type="text" :key="key" :name="key" v-model="value.value" />
                </div>
                <!-- another field is needed here, which is calculated from the value of the stat, using the DND formula -->
                <label class="w-full">Modifier</label>
                <span>{{ calculateModifier(value.value) }}</span>
             </div>
             <div class="bg-gray-200 p-2 w-3/5 shadow shadow-outline shadow-inner border mb-2">
             <b class="underline">Skills</b>
             <div v-for="(value, key) in skills" :key="key" class="section-skills">
                <label>{{ value.name }}</label> 
                | {{ shortenStat(value.associated_stat) }}
                <span v-if="character.sheet.skills.value">
              <span v-if="findSkillProf(character.sheet.skills.value, value.name)">| <b>proficient</b></span>
                </span>
                <!-- another field is needed here, which is calculated from the value of the stat, using the DND formula -->
              </div>
            </div>
              </div>
              <div class="mt-2 w-full">
                <div v-for="(value, key) in character.sheet" :key="key"  v-if="value.type == 'M'" class="section-header mb-1">
                    <div class="flex flex-col">
                    <label>{{ removeUnderline(key) }}</label>  
                    <input class="w-2/3" type="text" :key="key" :name="key" v-model="value.value" />
                    </div>
              </div>
              </div>
              <div class="w-full">
                <div v-for="(value, key) in character.sheet" :key="key"  v-if="value.type == 'F'" class="section-header mb-1 flex flex-col">
                    <label class="underline font-bold mt-1">{{ removeUnderline(key) }}</label> 
                    <textarea v-if="key == 'features'" :key="key" :name="key" v-model="value.value" class="w-full h-64">{{ value }}</textarea>
                    <textarea v-else :key="key" :name="key" v-model="value.value" class="w-full h-32">{{ value }}</textarea>
                </div>
              </div>
              </div>
            <button class="bg-blue-500 w-24 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded" @click="updateSheet(character.sheets.id)">Update</button>
          </form>
        </div>
</div>
</div>
</body>
</html>
<script type="application/javascript">
    const VueApp = new Vue({
      el: '#app',
      data: {
        message: 'My Sheets',
        characters: [],
        skills: [],
      },
      methods: {
    calculateModifier(abilityScore) {
      return Math.floor((abilityScore - 10) / 2);
    },
    findSkillProf(skills, skillName) {
      return skills.find(skill => skill.name === skillName);
    },
    shortenStat(stat) {
      return stat.substring(0, 3).toUpperCase();
    },
    removeUnderline(string) {
      return string.replace(/_/g, ' ');
    },
    }
  
    });
    
    function UpdateSheet(id) {
    
    }
    function processSheet(data, mappings) {

        // This function will go through each data.characters.sheets and map the keys to the correct type, for logic in vue JS, e.g. if the key is "class" then the type is "B", for "Basic" and so on.
        // This will allow us to use the same logic for each sheet, and not have to worry about the type of sheet we are dealing with.
        // we will edit the data.characters.sheets object in place, and return it.
        // for each character data[x]
        data.forEach(function (character, index) {
        // First we need to get the keys of the data.characters.sheets object, and then we can loop through them.
        if(character.picture && character.picture.data) {
        var image = new Blob([new Uint8Array(character.picture.data)]);
        data[index].picture = URL.createObjectURL(image);
    };
        var keys = Object.keys(character.sheet);
        for (var i = 0; i < keys.length; i++) {
            // Now we have the keys, we can loop through them and check the mappings object to see what type of key it is.
            var key = keys[i];
            // we need to match this key to the mappings object, and get the type, this is not the index of the mappings array, but we need to exclude the "skills key"
            
            var type = mappings.find((element) => element.sheets_field_name == key);
            if (type == undefined) {
            // if the type is undefined, then we need to add a field_type of "U" for "Unknown"
            type = "U";
            }
            else {
            type = type.field_type;
            }
            // now we need to add in the type to the data.characters.sheets object.
            data[index].sheet[key] = {
            type: type,
            value: character.sheet[key],
            };
        }

    });
    // push data into vue app.
    VueApp.characters = data;
    };

    async function main() {
        var data = await initSheet();
        var mappings = await fetchMappings();
        var skills = await fetchSkills();
        VueApp.skills = skills;
        processSheet(data.characters, mappings);
      }
    main();
    
</script>
<style>
    * {
    
        font-family: 'IM Fell English SC', serif;
}

.parchment {

  display: flex;
  flex-direction: column;
  margin: 1em;
    padding: 3em;
    background-color: #f5f5f5;
    border: 1px solid #ccc;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.parchment_header {

    font-weight: bold;
  margin-bottom: 10px;
  color: #333;
    
}

.img-border {

    border: 5px ridge #A49319;

}
</style>
